# AI File Manager リファクタリング計画および進捗管理書

## 1. プロジェクト概要

*   **プロジェクト名**: AI File Manager リファクタリング
*   **作成日**: 2025年9月22日
*   **最終更新日**: 2025年9月22日
*   **目的**: AI File Manager アプリケーションのコードベースにおけるスパゲッティコードを解消し、保守性、拡張性、テスト容易性を大幅に向上させる。
*   **全体目標**: アプリケーションのアーキテクチャを改善し、将来的な機能追加や改修を容易にする。
*   **全体進捗**: 0% (各主要項目の進捗率に基づいて手動で更新)

---

## 2. 主要なリファクタリング項目と進捗

### 2.1. グローバルな状態オブジェクトの再設計と状態管理ライブラリの導入

*   **概要**: `AppState` と `ConversationHistory` の肥大化と密結合を解消し、状態管理をより構造化された予測可能なものにする。
*   **関連する問題点**: 3.1. グローバルな状態オブジェクトの肥大化と密結合
*   **項目進捗**: 0% (タスクの完了状況に基づいて手動で更新)
*   **タスクリスト**:
    *   [ ] 状態管理ライブラリの選定 (例: Zustand, Redux)
    *   [ ] `AppState` をドメインごとに分割 (例: `UIState`, `SettingsState`, `FileSystemState`, `PromptState`)
    *   [ ] `ConversationHistory` を独立した状態ストアとして再設計
    *   [ ] 各モジュールからの状態への直接アクセスを、選定したライブラリのAPI経由に変更
    *   [ ] 依存性注入 (DI) パターンの導入を検討し、状態ストアへの依存を管理

### 2.2. DOMへの直接操作の抽象化とUIコンポーネント化の徹底

*   **概要**: `elements` オブジェクトを介したDOMへの直接操作を排除し、UIを再利用可能なコンポーネントに分割する。
*   **関連する問題点**: 3.2. DOMへの直接操作と `elements` オブジェクトの肥大化
*   **項目進捗**: 0% (タスクの完了状況に基づいて手動で更新)
*   **タスクリスト**:
    *   [ ] UIフレームワークの選定 (例: React, Vue, Svelte)
    *   [ ] `public/src/core/config.js` から `elements` オブジェクトを削除
    *   [ ] 各UI要素をフレームワークのコンポーネントとして再構築
    *   [ ] HTML文字列の直接生成 (`innerHTML`) をコンポーネントのレンダリングロジックに置き換え
    *   [ ] インラインイベントハンドラをフレームワークのイベントシステムに移行

### 2.3. モジュール間の密結合の解消と責務の明確化 (SRPの徹底)

*   **概要**: 各モジュールの責務を明確にし、単一責任の原則を徹底することで、モジュール間の密結合を解消する。
*   **関連する問題点**: 3.3. モジュール間の密結合と責務の重複/分散
*   **項目進捗**: 0% (タスクの完了状況に基づいて手動で更新)
*   **タスクリスト**:
    *   [ ] **`APIClient`**: 会話履歴の更新ロジックを削除し、純粋なAPI通信のみに特化
    *   [ ] **`FileManagerService` (新設)**: `storageManager` を介したファイルシステム操作のビジネスロジックを集中管理
    *   [ ] **`MessageService` (新設)**: ユーザーメッセージ解析、AI応答処理、コマンドディスパッチに特化。UI表示はUIコンポーネントに委譲
    *   [ ] **`EventHandlerService` (新設)**: UIイベントのリスニングと、適切なサービスへの処理委譲のみを行う
    *   [ ] **`ModalService` (新設)**: モーダルの表示/非表示のビジネスロジックを集中管理。UI生成はUIコンポーネントに委譲
    *   [ ] **`FileEditorService` (新設)**: ファイルの表示、編集、差分管理のビジネスロジックを集中管理。UIレンダリングはUIコンポーネントに委譲
    *   [ ] **`PromptService` (新設)**: プロンプトの管理（CRUD）のビジネスロジックを集中管理。UI表示はUIコンポーネントに委譲
    *   [ ] イベントバス/パブリッシュ-サブスクライブパターンの導入を検討し、モジュール間の依存関係を疎結合化

### 2.4. 循環依存の解消

*   **概要**: `window` オブジェクトを介した不自然なモジュール参照を排除し、健全な依存関係を構築する。
*   **関連する問題点**: 3.4. 循環依存の回避策としての `window` オブジェクトの利用
*   **項目進捗**: 0% (タスクの完了状況に基づいて手動で更新)
*   **タスクリスト**:
    *   [ ] イベントバスまたはDIパターンを導入し、`window` オブジェクトへの依存を排除
    *   [ ] 各モジュールが必要な依存関係を明示的に宣言し、外部から注入されるように変更

### 2.5. ストレージ管理の一貫性の確保と `mockFileSystem` の分離

*   **概要**: 全てのストレージ操作を `storageManager` に統一し、`mockFileSystem` を本番コードから分離する。
*   **関連する問題点**: 3.5. ストレージ管理の一貫性の欠如
*   **項目進捗**: 0% (タスクの完了状況に基づいて手動で更新)
*   **タスクリスト**:
    *   [ ] `public/src/core/state.js` から `localStorage` への直接アクセスを削除し、`storageManager` を利用
    *   [ ] `public/src/api/message-processor.js` および `public/src/events/event-handlers.js` から `mockFileSystem` への直接アクセスを削除し、`FileManagerService` を利用
    *   [ ] `public/src/utils/helpers.js` の `storage` オブジェクトを削除または `storageManager` の内部実装として統合
    *   [ ] `mockFileSystem` をテスト/開発環境専用とし、本番ビルドから除外する仕組みを導入

### 2.6. その他の改善点

*   **概要**: 上記主要項目以外の細かな問題点を修正し、コード品質を向上させる。
*   **関連する問題点**: 3.6. その他の問題点
*   **項目進捗**: 0% (タスクの完了状況に基づいて手動で更新)
*   **タスクリスト**:
    *   [ ] `Helpers.delay` の使用箇所を見直し、本当に必要な場合のみに限定または代替手段を検討
    *   [ ] `EventHandlers.init()` 内の `FileViewController` の未定義参照を修正
    *   [ ] `prompt()` や `confirm()` をカスタムモーダルUIに置き換え
    *   [ ] `joinPath` の重複を解消し、`Helpers.joinPath` に統一
    *   [ ] コマンドのパスバリデーションを強化
    *   [ ] UIの非効率な再生成を解消 (UIフレームワーク導入により解決される可能性が高い)
    *   [ ] グローバルスコープの汚染を排除

---

## 3. 進捗管理のガイドライン

### 3.1. 進捗更新方法

*   各タスクの完了状況に応じて、チェックボックスを `[ ]` から `[x]` に変更してください。
*   各タスクの進捗率 (%) を適宜更新してください。
*   各「主要なリファクタリング項目」の進捗率は、その項目内のタスクの進捗率の平均値として手動で計算し、更新してください。
*   「全体進捗」は、各「主要なリファクタリング項目」の進捗率の平均値として手動で計算し、更新してください。

### 3.2. パーセンテージ評価の基準

*   **0%**: 未着手
*   **1-25%**: 調査、設計、計画段階
*   **26-50%**: 実装開始、主要な部分のプロトタイプ完成
*   **51-75%**: 実装完了、テスト開始
*   **76-99%**: テスト完了、バグ修正、レビュー中
*   **100%**: 完了

---