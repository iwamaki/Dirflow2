### server_pythonverシステム仕様書

#### 1. システム概要
このシステムは、LLMによってユーザーの自然言語指示を理解し、ファイル操作、コンテンツ分析、Web検索、一般質問などのタスクを自動実行するAIアシスタントのバックエンドです。複数のAIモデルと専門エージェントを連携させ、高度な対話と処理を実現します。責任駆動設計に基づき、各コンポーネントの役割を明確に分離しています。

#### 2. 主要機能

## サーバー (Server)
- Python適合フレームワーク（FastAPI推奨）ベースのメインエントリポイント
- APIルーティング、ミドルウェア適用、リクエスト処理
- システム全体の起点

  ### チャットオーケストレーター (Chat Orchestrator)
  - チャット処理全体の管理・制御
  - サービス間の協調とフロー制御

    #### エージェントディスパッチャー (Agent Dispatcher)
    - LLMによるユーザー意図分析と最適エージェント選択
    - エージェント実行制御とセッション管理

    #### LLMアダプター (LLM Adapter)
    - LangChainベースの複数AI API統一インターフェース
    - プロバイダー差異吸収、API呼び出し管理
    - 対応プロバイダー: Claude/OpenAI/Gemini/ローカルモデル(Ollama)

    #### プロンプトビルダー (Prompt Builder)
    - LangChainのPromptTemplateを活用した動的プロンプト構築
    - プロバイダー別・エージェント別の最適化
    - テンプレート管理とバージョニング

      ##### 専門エージェント (Specialist Agents)
      - ユーザー意図分析の結果、呼び出される専門エージェント
      - LangChainのTools & Agentsフレームワーク活用
      - ReACTパターンによる推論・実行サイクル
      - カスタムツールチェーンの構築

        1. ファイル操作エキスパート: ファイル/ディレクトリ操作
        2. コンテンツ分析エキスパート: ファイル読み込み/分析
        3. Web検索エキスパート: インターネット検索/情報収集
        4. 汎用アシスタント: 一般質問/説明/ガイダンス
        5. (追加可能)

      ##### LLMがつかうことができるツール

        1. Web検索サービス (Web Search Service)
        - LangChain使用の外部情報検索機能
        - 複数検索プロバイダー統合（Tavily/Google/DuckDuckGo）

        2. (追加可能)

    #### コマンドバリデーター (Command Validator)
    - コマンド妥当性・セキュリティ検証
    - 危険操作の検出と警告

    #### 会話マネージャー (Conversation Manager)
    - LangChainのMemory機能を活用した会話履歴管理
    - コンテキスト情報の自動最適化とサマリー生成
    - 長期記憶とセッション記憶の統合管理

    #### コンテキストビルダー (Context Builder)
    - レスポンス構築・整形
    - エラー処理とフォールバック制御

  ### ユーティリティ (Response Utils)
  - JSON解析、モック応答
  - ヘルスステータス生成
  - バリデーション、ログ出力

#### 3. 処理フローの概要
1.  ユーザーからのチャットリクエストがサーバーのAPIエンドポイントに到達します。
2.  サーバーはリクエストをチャットオーケストレーターに委譲します。
3.  チャットオーケストレーターは、会話マネージャーを使って会話履歴とコンテキストを準備し、入力の検証を行います。
4.  エージェントディスパッチャーがユーザーの意図を分析し、最適な専門エージェント（ファイル操作、コンテンツ分析、Web検索、汎用アシスタント）を選択します。
5.  選択されたエージェントは、LLMアダプターとプロンプトビルダーを介してLLMに問い合わせを行い、タスクに応じた応答とコマンドを生成します。Web検索が必要な場合は、Web検索サービスが利用されます。
6.  生成されたコマンドはコマンドバリデーターによってセキュリティと妥当性が検証されます。
7.  チャットオーケストレーターは、コンテキストビルダーを使用して最終的なレスポンスを構築し、ユーザーに返却します。
8.  会話履歴は会話マネージャーによって更新・管理されます。

#### 4. データフロー
*   **入力**: ユーザーメッセージ、LLMプロバイダー、モデル、現在のコンテキスト（作業ディレクトリパス、開いているファイル、会話履歴など）。
*   **内部処理**:
    *   LLMへのプロンプト生成（システムプロンプト、カスタムプロンプト、履歴、コンテキストの統合）。
    *   LLMからの応答（自然言語メッセージ、実行すべきコマンド）。
    *   コマンドの検証結果。
    *   Web検索クエリと検索結果。
*   **出力**: ユーザーへの自然言語メッセージ、実行すべきコマンドのリスト、LLMプロバイダー情報、処理時間、メタデータ、エラー情報。

#### 5. セキュリティと堅牢性
*   コマンドバリデーターによるパスのセキュリティチェックや危険な操作の警告。
*   LLMアダプターによるAPIキーの安全な管理（環境変数）。
*   チャットオーケストレーターとコンテキストビルダーによるエラーハンドリングとフォールバック処理。
*   会話マネージャーによる履歴の最適化とメモリ使用量の管理。