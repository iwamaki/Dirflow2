### システム仕様書

#### 1. システム概要
このシステムは、ユーザーの自然言語指示を理解し、ファイル操作、コンテンツ分析、Web検索、一般質問などのタスクを自動実行するAIアシスタントのバックエンドです。複数のAIモデルと専門エージェントを連携させ、高度な対話と処理を実現します。責任駆動設計に基づき、各コンポーネントの役割を明確に分離しています。

#### 2. 主要機能

- **サーバー (Server)**  
  **責任の大きさ: 高**（システムの入り口で、全リクエストを処理）  
  - Express.jsベースのメインエントリポイント。  
  - APIルーティング、ミドルウェア適用、チャットリクエストの処理。  
  - LLM情報提供、システムステータス、エラーハンドリング、ログ出力。

- **チャットオーケストレーター (Chat Orchestrator)**  
  **責任の大きさ: 高**（全体の処理フローを統制）  
  - チャット処理のメイン管理。  
  - 入力検証、コンテキスト準備、エージェント委譲、コマンド検証、最終レスポンス構築。  
  - サービス協調制御、エラーフォールバック。

- **エージェントディスパッチャー (Agent Dispatcher)**  
  **責任の大きさ: 中**（タスク振り分けの鍵）  
  - ユーザーの意図分析と最適エージェント選択。  
  - エージェントとの継続対話管理、セッションリセット提案。

- **LLMアダプター (LLM Adapter)**  
  **責任の大きさ: 中**（AIモデル統合の橋渡し）  
  - Anthropic、OpenAI、GoogleなどのLLM API統一インターフェース。  
  - プロバイダー差異吸収、APIキー管理、エラーハンドリング、プロンプト最適化。

- **プロンプトビルダー (Prompt Builder)**  
  **責任の大きさ: 中**（LLMへの指示生成）  
  - 動的プロンプト構築（システムプロンプト、履歴、コンテキスト統合）。  
  - LLMプロバイダー適した形式生成。

- **専門エージェント (Specialist Agents)**  
  **責任の大きさ: 中**（タスク実行の専門家）  
  - **ファイル操作エキスパート**: ファイル/ディレクトリ操作（作成、編集、削除など）。  
  - **コンテンツ分析エキスパート**: ファイル読み込み、分析、要約、検索。  
  - **Web検索エキスパート**: インターネット検索、結果要約。  
  - **汎用アシスタント**: システム説明、一般質問、ガイダンス。

- **会話マネージャー (Conversation Manager)**  
  **責任の大きさ: 中**（会話の維持管理）  
  - 会話履歴管理・最適化（長さ制限、重複除去）。  
  - コンテキスト情報整理（ディレクトリ、ファイル）。  
  - 新チャット開始提案判断。

- **コマンドバリデーター (Command Validator)**  
  **責任の大きさ: 高**（セキュリティ確保）  
  - 操作コマンドの妥当性・セキュリティ検証。  
  - 許可チェック、パスセキュリティ、危険操作警告。

- **コンテキストビルダー (Context Builder)**  
  **責任の大きさ: 中**（レスポンス整形）  
  - APIレスポンス構築・フォーマット。  
  - 成功/エラー/フォールバックレスポンス整形、メタデータ追加。

- **Web検索サービス (Web Search Service)**  
  **責任の大きさ: 中**（外部情報取得）  
  - LangChain使用のWeb検索実行。  
  - 複数プロバイダー統合、結果整形・フィルタリング、履歴保持。

- **ユーティリティ (Response Utils)**  
  **責任の大きさ: 低**（補助機能）  
  - JSON解析、モック応答、ヘルスステータス、バリデーション、ログ出力。

#### 3. 処理フローの概要
1.  ユーザーからのチャットリクエストがサーバーのAPIエンドポイントに到達します。
2.  サーバーはリクエストをチャットオーケストレーターに委譲します。
3.  チャットオーケストレーターは、会話マネージャーを使って会話履歴とコンテキストを準備し、入力の検証を行います。
4.  エージェントディスパッチャーがユーザーの意図を分析し、最適な専門エージェント（ファイル操作、コンテンツ分析、Web検索、汎用アシスタント）を選択します。
5.  選択されたエージェントは、LLMアダプターとプロンプトビルダーを介してLLMに問い合わせを行い、タスクに応じた応答とコマンドを生成します。Web検索が必要な場合は、Web検索サービスが利用されます。
6.  生成されたコマンドはコマンドバリデーターによってセキュリティと妥当性が検証されます。
7.  チャットオーケストレーターは、コンテキストビルダーを使用して最終的なレスポンスを構築し、ユーザーに返却します。
8.  会話履歴は会話マネージャーによって更新・管理されます。

#### 4. データフロー
*   **入力**: ユーザーメッセージ、LLMプロバイダー、モデル、現在のコンテキスト（作業ディレクトリパス、開いているファイル、会話履歴など）。
*   **内部処理**:
    *   LLMへのプロンプト生成（システムプロンプト、カスタムプロンプト、履歴、コンテキストの統合）。
    *   LLMからの応答（自然言語メッセージ、実行すべきコマンド）。
    *   コマンドの検証結果。
    *   Web検索クエリと検索結果。
*   **出力**: ユーザーへの自然言語メッセージ、実行すべきコマンドのリスト、LLMプロバイダー情報、処理時間、メタデータ、エラー情報。

#### 5. セキュリティと堅牢性
*   コマンドバリデーターによるパスのセキュリティチェックや危険な操作の警告。
*   LLMアダプターによるAPIキーの安全な管理（環境変数）。
*   チャットオーケストレーターとコンテキストビルダーによるエラーハンドリングとフォールバック処理。
*   会話マネージャーによる履歴の最適化とメモリ使用量の管理。