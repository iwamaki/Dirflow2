### システム仕様書

#### 1. システム概要
本システムは、ユーザーの自然言語による指示を解釈し、ファイル操作、コンテンツ分析、Web検索、一般的な質問応答といった多様なタスクを自動で実行するAIアシスタントのバックエンドです。複数のAIモデル（LLM）と専門エージェントを連携させることで、高度な対話とタスク処理を実現します。

#### 2. 主要コンポーネントと役割
*   **サーバー (Server)**
    *   Express.jsをベースとしたバックエンドアプリケーションのメインエントリポイントです。
    *   APIエンドポイントのルーティング定義、ミドルウェアの適用、ChatOrchestratorを介したチャットリクエストの処理、LLMプロバイダー情報やシステムステータスの提供、エラーハンドリング、サーバー起動ログの出力を行います。

*   **チャットオーケストレーター (Chat Orchestrator)**
    *   システム全体のメインエントリーポイントであり、チャット処理のフローを管理します。
    *   ユーザー入力の検証、会話コンテキストの準備、エージェントへのタスク委譲、コマンドの検証、最終レスポンスの構築を行います。
    *   各サービス間の協調を制御し、エラー発生時にはフォールバック処理を提供します。

*   **エージェントディスパッチャー (Agent Dispatcher)**
    *   ユーザーの意図を分析し、最も適切な専門エージェント（後述）を選択してタスクを振り分けます。
    *   一度選択されたエージェントとの継続的な対話を管理し、必要に応じてセッションのリセットを提案します。

*   **LLMアダプター (LLM Adapter)**
    *   Anthropic (Claude)、OpenAI (GPT)、Google (Gemini)、ローカルLLMなど、複数のLLMプロバイダーのAPI呼び出しを統一されたインターフェースで扱います。
    *   プロバイダー間の差異を吸収し、APIキーの管理、エラーハンドリング、プロンプト形式の最適化を行います。

*   **プロンプトビルダー (Prompt Builder)**
    *   LLMへのリクエストに必要なプロンプトを動的に構築します。
    *   システムプロンプト、カスタムプロンプト、会話履歴、現在のコンテキスト情報（現在のディレクトリ、開いているファイルなど）を統合し、選択されたLLMプロバイダーに適した形式でプロンプトを生成します。

*   **専門エージェント (Specialist Agents)**
    *   **ファイル操作エキスパート**: ファイルやディレクトリの作成、編集、削除、移動、コピーなどの操作を専門とします。
    *   **コンテンツ分析エキスパート**: ファイル内容の読み込み、分析、要約、検索を専門とします。
    *   **Web検索エキスパート**: インターネット検索、情報収集、リサーチを専門とします。検索結果の要約と分析も行います。
    *   **汎用アシスタント**: システムの使い方説明、一般的な質問応答、ガイダンス提供など、明確な操作を伴わない対話を担当します。

*   **会話マネージャー (Conversation Manager)**
    *   ユーザーとの会話履歴を管理し、最適化します（履歴の長さ制限、重複除去など）。
    *   現在の作業ディレクトリパス、開いているファイルなどのコンテキスト情報を整理・拡張します。
    *   会話の長さやトピックの変化に基づいて、新しいチャットの開始を提案すべきかを判断します。

*   **コマンドバリデーター (Command Validator)**
    *   AIエージェントが提案した操作コマンド（ファイル操作、Web検索など）の妥当性とセキュリティを検証します。
    *   許可されたアクションのチェック、必須フィールドの確認、パスのセキュリティチェック、危険な操作（削除など）の検出と警告を行います。

*   **コンテキストビルダー (Context Builder)**
    *   APIレスポンスの最終的な構築とフォーマットを行います。
    *   成功時のレスポンス、エラー時のレスポンス、フォールバックレスポンスを整形し、一貫した形式で提供します。
    *   レスポンスにメタデータ（処理時間、使用エージェントなど）を追加します。

*   **Web検索サービス (Web Search Service)**
    *   LangChainライブラリを利用してWeb検索を実行します。
    *   Tavily、Google Custom Search、DuckDuckGoなど複数の検索プロバイダーを統合し、最適なプロバイダーを選択します。
    *   検索結果の整形、フィルタリング、検索履歴の保持を行います。

*   **ユーティリティ (Response Utils)**
    *   AI応答の構造化されたJSON形式の解析、デモモード用のモック応答の提供、サーバーのヘルスステータス生成、チャット入力の基本バリデーション、サーバー起動ログの出力など、共通のユーティリティ機能を提供します。

#### 3. 処理フローの概要
1.  ユーザーからのチャットリクエストがサーバーのAPIエンドポイントに到達します。
2.  サーバーはリクエストをチャットオーケストレーターに委譲します。
3.  チャットオーケストレーターは、会話マネージャーを使って会話履歴とコンテキストを準備し、入力の検証を行います。
4.  エージェントディスパッチャーがユーザーの意図を分析し、最適な専門エージェント（ファイル操作、コンテンツ分析、Web検索、汎用アシスタント）を選択します。
5.  選択されたエージェントは、LLMアダプターとプロンプトビルダーを介してLLMに問い合わせを行い、タスクに応じた応答とコマンドを生成します。Web検索が必要な場合は、Web検索サービスが利用されます。
6.  生成されたコマンドはコマンドバリデーターによってセキュリティと妥当性が検証されます。
7.  チャットオーケストレーターは、コンテキストビルダーを使用して最終的なレスポンスを構築し、ユーザーに返却します。
8.  会話履歴は会話マネージャーによって更新・管理されます。

#### 4. データフロー
*   **入力**: ユーザーメッセージ、LLMプロバイダー、モデル、現在のコンテキスト（作業ディレクトリパス、開いているファイル、会話履歴など）。
*   **内部処理**:
    *   LLMへのプロンプト生成（システムプロンプト、カスタムプロンプト、履歴、コンテキストの統合）。
    *   LLMからの応答（自然言語メッセージ、実行すべきコマンド）。
    *   コマンドの検証結果。
    *   Web検索クエリと検索結果。
*   **出力**: ユーザーへの自然言語メッセージ、実行すべきコマンドのリスト、LLMプロバイダー情報、処理時間、メタデータ、エラー情報。

#### 5. セキュリティと堅牢性
*   コマンドバリデーターによるパスのセキュリティチェックや危険な操作の警告。
*   LLMアダプターによるAPIキーの安全な管理（環境変数）。
*   チャットオーケストレーターとコンテキストビルダーによるエラーハンドリングとフォールバック処理。
*   会話マネージャーによる履歴の最適化とメモリ使用量の管理。

このシステムは、モジュール間の責任を明確に分離した「責任駆動設計 (Responsibility-Driven Design: RDD)」に基づいて構築されており、拡張性と保守性に優れています。